//Copyright 2020-2023 Kenneth Claassen. All Rights Reserved.

#pragma once

#include "CoreMinimal.h"
#include "Components/ActorComponent.h"
#include "Objects/Assets/MotionMatchConfig.h"
#include "Data/Trajectory.h"
#include "Data/InputProfile.h"
#include "GameFramework/NavMovementComponent.h"
#include "TrajectoryGenerator_Base.generated.h"

enum class ETrajectoryControlMode : uint8;
class UCameraComponent;

UCLASS(BlueprintType, Category = "Motion Matching", meta = (BlueprintSpawnableComponent))
class MOTIONSYMPHONY_API UTrajectoryGenerator_Base : public UActorComponent
{
	GENERATED_BODY()

public:
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Settings)
	UMotionMatchConfig* MotionMatchConfig;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Settings, meta = (ClampMin = 0.0f, ClampMax = 0.25f))
	float RecordingFrequency;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Settings, meta = (ClampMin = 6.0f))
	float SampleRate;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Settings)
	bool bFlattenTrajectory;
	
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Debug)
	bool bDebugRandomInput;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Debug)
	FVector2D DebugTimeIntervalRange;

#if WITH_EDITORONLY_DATA
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Debug")
	bool bDrawTrajectory = false;
#endif

	//Trajectory
	UPROPERTY()
	FTrajectory Trajectory;

	UPROPERTY()
	FVector InputVector;

protected:
	//Past Trajectory
	float MaxRecordTime;
	float TimeSinceLastRecord;
	TArray<FVector> RecordedPastPositions;
	TArray<float> RecordedPastRotations;
	TArray<float> RecordedPastTimes;
	float CumActiveTime;

	//Tracking
	float TimeHorizon;
	float TimeStep;
	int TrajectoryIterations;
	float CurFacingAngle;
	
	TArray<FVector> TrajPositions;
	TArray<float> TrajRotations;
	TArray<float> TrajTimes;

	//Debug
	float TimeSinceLastDebugInputChange;
	float TimeToChangeDebugInput;
	FVector DebugInputVector;

	//Character
	AActor* OwningActor;

	FInputProfile* InputProfile;
	
	float CharacterFacingOffset;

private:
	bool bExtractedThisFrame;
	FTransform CacheCharacterTransform;

	USkeletalMeshComponent* SkelMeshComponent;
	
public:	
	// Sets default values for this component's properties
	UTrajectoryGenerator_Base();

public:
	/** Sets the X axis of the trajectory input vector */
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Input")
	void SetTrajectoryInputX(float XAxisValue);

	/** Sets the Y axis of the trajectory input vector */
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Input")
	void SetTrajectoryInputY(float YAxisValue);

	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Input")
	void SetTrajectoryInputZ(float ZAxisValue);

	/** Sets the Input vector for the trajectory generator */
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Input")
	void SetTrajectoryInput(float XAxisValue, float YAxisValue, float ZAxisValue = 0.0f);

	/** Sets the Input profile to use */
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Input")
	void SetInputProfile(UPARAM(ref) FInputProfile& InInputProfile);

	/** Clears the Input profile from the trajectory generator so that input will no longer
	be remapped */
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Input")
	void ClearInputProfile();

	/** Returns the last trajectory that was generated by this trajectory generator*/
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory")
	const FTrajectory& GetCurrentTrajectory() const;

	/** Debug function that can be used to draw the trajectory*/
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Debug")
	void DrawTrajectoryDebug(FVector DrawOffset);

	/** Checks if the Trajectory is in an idle state. This means it has no
	magnitude in the past or future and no varying facing angles */
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory")
	bool IsIdle();

	/** Returns true if the input vector is greater than zero magnitude at the time of 
	calling */
	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory/Input")
	bool HasMoveInput();

	UFUNCTION(BlueprintCallable, Category = "MotionMatching/Trajectory")
	void SetCharacterSkeletalMeshComponent(USkeletalMeshComponent* InSkelMesh);

	virtual void TickComponent(float DeltaTime, ELevelTick TickType,
	FActorComponentTickFunction* ThisTickFunction) override;

	virtual void BeginPlay() override;

protected:
	void RecordPastTrajectory(float DeltaTime);
	virtual void UpdatePrediction(float DeltaTime);
	virtual void ApplyDebugInput(float DeltaTime);

	virtual bool IsValidToUpdatePrediction();

#if WITH_EDITORONLY_DATA
	virtual void DebugDrawTrajectory(const float InDeltaTime);
#endif

private:
	virtual void Setup(TArray<float>& InTrajTimes);
	void ExtractTrajectory();
	inline void ClampInputVector();
};
